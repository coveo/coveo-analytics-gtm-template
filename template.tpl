___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "Coveo Analytics",
  "description": "The Coveo Analytics template allows you to log events to Coveo Usage Analytics.",
  "categories": [
    "ANALYTICS",
    "PERSONALIZATION",
    "SESSION_RECORDING"
  ],
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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",
    "displayName": "coveo",
    "id": "github.com_coveo"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Send page view",
        "value": "view"
      },
      {
        "value": "event",
        "displayValue": "Send event"
      },
      {
        "displayValue": "Initialize the Coveo Analytics script",
        "value": "load"
      },
      {
        "value": "custom",
        "displayValue": "Send event (legacy custom events)"
      }
    ],
    "displayName": "Action",
    "simpleValueType": true,
    "name": "eventType",
    "type": "SELECT",
    "help": "The action to perform when the tag is triggered (see \u003ca href\u003d\"https://docs.coveo.com/en/2926/\"\u003eLogging Coveo Events From Google Tag Manager\u003c/a\u003e)."
  },
  {
    "name": "Event Description",
    "type": "GROUP",
    "subParams": [
      {
        "enablingConditions": [
          {
            "paramName": "eventType",
            "type": "EQUALS",
            "paramValue": "custom"
          }
        ],
        "displayName": "This type of event is deprecated, use Send Event and Send Page View instead.",
        "name": "Custom Coveo Event Type Description",
        "type": "LABEL"
      },
      {
        "enablingConditions": [
          {
            "paramName": "eventType",
            "type": "EQUALS",
            "paramValue": "load"
          }
        ],
        "displayName": "This action should be performed once per page before logging events to Coveo Usage Analytics (see \u003ca href\u003d\"https://docs.coveo.com/en/2926/#loading-the-coveo-analytics-script\"\u003eLoading the Coveo Analytics Script\u003c/a\u003e).",
        "name": "Load Event Type Description",
        "type": "LABEL"
      },
      {
        "enablingConditions": [
          {
            "paramName": "eventType",
            "type": "EQUALS",
            "paramValue": "view"
          }
        ],
        "displayName": "Page view events are leveraged by Coveo ML Event Recommendation models (see \u003ca href\u003d\"https://docs.coveo.com/en/1886/\"\u003eCoveo Machine Learning Event Recommendations Deployment Overview\u003c/a\u003e).",
        "name": "View Event Type Description",
        "type": "LABEL"
      },
      {
        "type": "LABEL",
        "name": "Event Type Description",
        "displayName": "Events are used to send the data accumulated in the data layer or with other commands on the page.",
        "enablingConditions": [
          {
            "paramName": "eventType",
            "paramValue": "event",
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "eventType",
        "type": "EQUALS",
        "paramValue": "custom"
      }
    ],
    "displayName": "Event metadata",
    "name": "Custom Event Metadata",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "The broad category to associate the custom event with (e.g., \u003ccode\u003ePage Navigation\u003c/code\u003e).",
        "displayName": "Event type",
        "simpleValueType": true,
        "name": "customEventType",
        "type": "TEXT"
      },
      {
        "help": "A concise description of the specific action that triggered the custom event (e.g., \u003ccode\u003eClick Help Button\u003c/code\u003e).",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "displayName": "Event value",
        "simpleValueType": true,
        "name": "customEventValue",
        "type": "TEXT"
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "eventType",
        "type": "EQUALS",
        "paramValue": "custom"
      }
    ],
    "displayName": "Document metadata",
    "name": "Document Metadata",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "help": "The language of the current page. Must be a valid \u003ca href\u003d\u0027https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes\u0027\u003eISO-639-1 code\u003c/a\u003e (e.g., \u003ccode\u003een\u003c/code\u003e)",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "displayName": "Language",
        "simpleValueType": true,
        "name": "language",
        "type": "TEXT"
      },
      {
        "help": "(Optional) The URL of the current page. Defaults to \u003ccode\u003ewindow.location\u003c/code\u003e.",
        "displayName": "Location",
        "simpleValueType": true,
        "name": "location",
        "type": "TEXT"
      },
      {
        "help": "(Optional) The title of the current page. Defaults to \u003ccode\u003edocument.title\u003c/code\u003e.",
        "displayName": "Title",
        "simpleValueType": true,
        "name": "title",
        "type": "TEXT"
      },
      {
        "help": "(Optional) Whether the current end user is anonymous. Allowed values are \u003ccode\u003etrue\u003c/code\u003e and \u003ccode\u003efalse\u003c/code\u003e. Defaults to \u003ccode\u003efalse\u003c/code\u003e.",
        "displayName": "Is anonymous",
        "simpleValueType": true,
        "name": "isAnonymous",
        "type": "TEXT"
      },
      {
        "displayName": "Username",
        "simpleValueType": true,
        "name": "username",
        "type": "TEXT"
      },
      {
        "help": "(Optional) A human-readable name to display in usage analytics reports for the current user (e.g., \u003ccode\u003eAlice Smith\u003c/code\u003e).",
        "enablingConditions": [
          {
            "paramName": "username",
            "type": "PRESENT",
            "paramValue": ""
          }
        ],
        "displayName": "User display name",
        "simpleValueType": true,
        "name": "userDisplayName",
        "type": "TEXT"
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "eventType",
        "type": "EQUALS",
        "paramValue": "custom"
      },
      {
        "paramName": "eventType",
        "paramValue": "view",
        "type": "EQUALS"
      },
      {
        "paramName": "eventType",
        "paramValue": "event",
        "type": "EQUALS"
      }
    ],
    "displayName": "Override Metadata",
    "name": "Custom Data",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "customDataTable",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Key",
            "name": "key",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE"
      },
      {
        "name": "customDataObjects",
        "simpleTableColumns": [
          {
            "macrosInSelect": true,
            "selectItems": [],
            "valueValidators": [],
            "defaultValue": "",
            "help": "A JavaScript object to merge with the other specified custom metadata.",
            "displayName": "Object to merge",
            "name": "object",
            "type": "SELECT"
          }
        ],
        "type": "SIMPLE_TABLE"
      }
    ]
  },
  {
    "displayName": "Configuration",
    "name": "Configuration",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "help": "An API key granting only the \u003cstrong\u003eUsage Analytics - Push\u003c/strong\u003e privilege in the target Coveo Cloud organization (see \u003ca href\u003d\"https://docs.coveo.com/en/1718/\"\u003eAdding and Managing API Keys\u003c/a\u003e).",
        "valueValidators": [
          {
            "enablingConditions": [
              {
                "paramName": "eventType",
                "type": "EQUALS",
                "paramValue": "load"
              }
            ],
            "type": "NON_EMPTY"
          }
        ],
        "displayName": "API key",
        "simpleValueType": true,
        "name": "apiKey",
        "type": "TEXT"
      },
      {
        "macrosInSelect": true,
        "selectItems": [
          {
            "displayValue": "Coveo Cloud",
            "value": "https://analytics.cloud.coveo.com/rest/ua"
          },
          {
            "displayValue": "Coveo Cloud (HIPAA)",
            "value": "https://analyticshipaa.cloud.coveo.com/rest/ua"
          }
        ],
        "valueValidators": [],
        "help": "The target Coveo Cloud platform environment.",
        "displayName": "Analytics endpoint",
        "simpleValueType": true,
        "name": "analyticsEndpoint",
        "type": "SELECT"
      },
      {
        "help": "The version of the script to load",
        "valueValidators": [
          {
            "args": [
              "\\d(\\.\\d)?(\\.\\d)?(\\-[a-z0-9]+)?"
            ],
            "enablingConditions": [
              {
                "paramName": "scriptVersion",
                "type": "PRESENT",
                "paramValue": ""
              }
            ],
            "errorMessage": "You must use the format \u003ccode\u003eMAJOR.MINOR\u003c/code\u003e (e.g., \u003ccode\u003e1.0\u003c/code\u003e)",
            "type": "REGEX"
          }
        ],
        "displayName": "Script version",
        "simpleValueType": true,
        "name": "scriptVersion",
        "type": "TEXT",
        "valueHint": "2.0"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const JSON = require('JSON');
const isLoadEventType = () => data.eventType === "load";

const isSomewhatAJSON = (value) => typeof value === 'string' && value.indexOf("{") !== -1 && value.indexOf("}") !== -1;
const getAsJSONOrValue = (value) => {
  return (isSomewhatAJSON(value) && JSON.parse(value)) || value;
};

const validateVariablesToLoadScript = () => {
  const COMMON_ERROR_MESSAGE = "Coveo Analytics Script could not be initialized.\n";

  const missingKeys = ['analyticsEndpoint', 'apiKey'].filter(key => !data[key]);
  const hasMissingKeys = missingKeys.length > 0;
  if (missingKeys.length > 0) {
    if (isLoadEventType()) {
      log(COMMON_ERROR_MESSAGE + "The \"Configuration\" section is missing the following keys: " + missingKeys.join(", "));
    } else {
      log(COMMON_ERROR_MESSAGE + "You must either provide the variables in the \"Configuration\" section to the first Coveo Analytics tag or add the \"Load\" event type before this tag.");
    }
    return false;
  }

  return true;
};

const loadCoveoAnalyticsScript = (onSuccess) => {
  const injectScript = require("injectScript");
  const setInWindow = require("setInWindow");

  const createArgumentsQueue = require('createArgumentsQueue');
  const coveoua = createArgumentsQueue('coveoua', 'coveoua.q');
  const getTimestamp = require('getTimestamp');
  setInWindow('coveoua.t', getTimestamp(), true);

  coveoua("init", data.apiKey, data.analyticsEndpoint);
  coveoua("onLoad", function() {
    log('Coveo Analytics Initialized');
  });

  const scriptVersion = data.scriptVersion || "2";
  const url = "https://static.cloud.coveo.com/coveo.analytics.js/" + scriptVersion + "/coveoua.js";
  injectScript(url, onSuccess, data.gtmOnFailure, url);
};

const loadCoveoAnalyticsScriptIfNotLoaded = (onSuccess, onFailure) => {
  const copyFromWindow = require("copyFromWindow");
  const isLoaded = copyFromWindow("coveoua");

  if (!isLoaded) {
    if (!validateVariablesToLoadScript()) {
      onFailure();
    }
    loadCoveoAnalyticsScript(onSuccess);
  } else {
    onSuccess();
  }
};

const addToObject = function(obj) {
  for (let index in arguments) {
    const obj2 = arguments[index];
    for (let key in obj2) {
      if (obj2.hasOwnProperty(key)) {
        obj[key] = obj2[key];
      }
    }
  }
  return obj;
};

const isObjectEmpty = function(obj) {
  for (let key in obj) {
    if (obj.hasOwnProperty(key)) {
      return false;
    }
  }
  return true;
};

const generateCustomData = () => {
  const customDataObject = {};

  if (!!data.customDataTable && data.customDataTable.length > 0) {
    const makeParsedTableMap = (table) => {
      const makeTableMap = require('makeTableMap');
      const tableWithParsedValues = table.map((row) => ({key: row.key, value: getAsJSONOrValue(row.value)}));
      return makeTableMap(tableWithParsedValues, 'key', 'value');
    };

    const objForUsageAnalytics = makeParsedTableMap(data.customDataTable);
    addToObject(customDataObject,
                objForUsageAnalytics);
  }

  if (!!data.customDataObjects && data.customDataObjects.length > 0) {
    const getValidCustomDataObjectsFromArray = (objects) => {
      return objects.map(row => row.object).map(getAsJSONOrValue).filter(obj => typeof obj === 'object');
    };

    getValidCustomDataObjectsFromArray(data.customDataObjects)
      .forEach(obj => addToObject(customDataObject, obj));
  }

  return customDataObject;
};

const eventTypeMap = {
  custom: "custom"
};

const eventDataForTypeMap = {
  custom: {
    eventType: data.customEventType,
    eventValue: data.customEventValue,
    customData: {}
  }
};

const measurementProtocolTypeMap = {
  view: 'pageview',
  event: 'event'
};

const logWithMeasurementProtocol = () => {
  const copyFromDataLayer = require("copyFromDataLayer");
  const event = copyFromDataLayer('event');
  const ecommerce = copyFromDataLayer('ecommerce');

  const createArgumentsQueue = require('createArgumentsQueue');
  const coveoua = createArgumentsQueue('coveoua', 'coveoua.q');

  if (ecommerce) {
    const setAction = (action, metadata) => !!metadata ? coveoua("ec:setAction", action, metadata) : coveoua("ec:setAction", action);
    const addAllProductsIfDefined = (products) => !!products && products.forEach(product => coveoua("ec:addProduct", product));
    const addAllImpressionsIfDefined = (impressions) => !!impressions && impressions.forEach(impression => coveoua("ec:addImpression", impression));

    if (ecommerce.currencyCode) {
      coveoua("set", "currencyCode", ecommerce.currencyCode); 
    }

    const eventMapping = {
      "gtm.load": ["refund", "purchase", "detail"],
      "gtm.dom": ["refund", "purchase", "detail"],
      "addToCart": ["add"],
      "removeFromCart": ["remove"],
      "checkout": ["checkout"],
      "checkoutOption": ["checkout_option"],
      "productClick": ["click"],
      // Custom event type, in case you want to send them after "gtm.load" or "gtm.dom".
      "refund": ["refund"],
      "purchase": ["purchase"],
      "detailView": ["detail"],
      "impression": ["impression", "impressions"]
    };

    const customCoveoActionsOverride = {
      "impressions": "impression"
    };

    const eventsToTest = eventMapping[event];
    const eventsFoundForType = !!eventsToTest && eventsToTest.filter(e => ecommerce.hasOwnProperty(e));
    const ecommerceDataLayerToUse = eventsFoundForType.length > 0 && ecommerce[eventsFoundForType[0]];

    if (ecommerceDataLayerToUse) {
      addAllProductsIfDefined(ecommerceDataLayerToUse.products);
      addAllImpressionsIfDefined(ecommerceDataLayerToUse.impressions);
      const action = eventsFoundForType[0];
      setAction(customCoveoActionsOverride[action] || action, ecommerceDataLayerToUse.actionField);
    }

    addAllImpressionsIfDefined(ecommerce.impressions);
  }

  log('Coveo Using Measurement Protocol');

  const customData = generateCustomData();
  if (isObjectEmpty(customData)) {
    coveoua("send", measurementProtocolTypeMap[data.eventType]);
  } else {
    coveoua("send", measurementProtocolTypeMap[data.eventType], customData);
  }
};

const logCoveoAnalyticsEvent = () => {
  const eventDataForType = eventDataForTypeMap[data.eventType];
  addToObject(eventDataForType.customData, generateCustomData());

  const getUrl = require("getUrl");
  const getReferrerUrl = require("getReferrerUrl");
  const readTitle = require("readTitle");
  const eventData = {
    location: data.location || getUrl(),
    referrer: data.referrer || getReferrerUrl(),
    language: data.language,
    title: data.title || readTitle(),
    anonymous: data.isAnonymous,
    username: data.username,
    userDisplayName: data.userDisplayName
  };

  addToObject(eventData, eventDataForType);

  log('Coveo Analytics Data =', eventData);

  const createArgumentsQueue = require('createArgumentsQueue');
  const coveoua = createArgumentsQueue('coveoua', 'coveoua.q');
  coveoua("send", eventTypeMap[data.eventType], eventData);
};

loadCoveoAnalyticsScriptIfNotLoaded(() => {
  if (!isLoadEventType()) {
     if (eventDataForTypeMap[data.eventType]) {
     	logCoveoAnalyticsEvent();
     } else {
      	logWithMeasurementProtocol(); 
     }
  }
  data.gtmOnSuccess();
}, () => {
  data.gtmOnFailure();
});


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "coveoua"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "coveoua.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "coveoua.t"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "coveoanalytics"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_title",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://static.cloud.coveo.com/coveo.analytics.js/*/coveoua.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ecommerce"
              },
              {
                "type": 1,
                "string": "event"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Throws when logging without init
  code: |-
    const mockData = {
      "eventType": "view"
    };

    runCode(mockData);

    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Sends a Page View event
  code: |-
    givenScriptInitialized();
    givenMockDataLayer({
      "event": "gtm.dom",
      "ecommerce": {}
    });

    const mockData = {
      "eventType": "view"
    };

    runCode(mockData);

    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertEventWasSentWith("pageview");
- name: Adds Enhanced Commmerce Products with a Detail Page View event
  code: "const product = {\n   \"productName\": \"wow\" \n};\n\ngivenScriptInitialized();\n\
    \ngivenMockDataLayer({\n  \"event\": \"gtm.dom\",\n  \"ecommerce\": {\n  \t\"\
    detail\": {\n      \"products\": [product]\n    }\n  }\n});\n\nconst mockData\
    \ = {\n  \"eventType\": \"view\"\n};\n\nrunCode(mockData);\n\nassertApi('gtmOnFailure').wasNotCalled();\n\
    assertApi('gtmOnSuccess').wasCalled();\nassertActionWasQueued([\"ec:setAction\"\
    , \"detail\"]);\nassertActionWasQueued([\"ec:addProduct\", product]);\nassertEventWasSentWith(\"\
    pageview\");"
- name: Allows sending a Page View without ecommerce in data layer
  code: |-
    givenScriptInitialized();
    givenMockDataLayer({
      "event": "gtm.dom",
    });

    const mockData = {
      "eventType": "view"
    };

    runCode(mockData);

    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertEventWasSentWith("pageview");
- name: Propagates the ECommerce currencyCode to coveoua
  code: "givenScriptInitialized();\ngivenMockDataLayer({\n  \"event\": \"gtm.dom\"\
    ,\n  \"ecommerce\": {\n     \"currencyCode\": \"EUR\" \n  }\n});\n\nconst mockData\
    \ = {\n  \"eventType\": \"view\"\n};\n\nrunCode(mockData);\n\nassertApi('gtmOnFailure').wasNotCalled();\n\
    assertApi('gtmOnSuccess').wasCalled();\nassertActionWasQueued([\"set\", \"currencyCode\"\
    , \"EUR\"]);\nassertEventWasSentWith(\"pageview\");"
- name: Adds Impressions with a addToCart event
  code: "const product = {\n   \"productName\": \"wow\" \n};\n\nconst impression =\
    \ {\n   \"productName\": \"impression\" \n};\n\ngivenScriptInitialized();\n\n\
    givenMockDataLayer({\n  \"event\": \"addToCart\",\n  \"ecommerce\": {\n  \t\"\
    add\": {\n      \"products\": [product]\n    },\n    \"impressions\": [impression]\n\
    \  }\n});\n\nconst mockData = {\n  \"eventType\": \"event\"\n};\n\nrunCode(mockData);\n\
    \nassertApi('gtmOnFailure').wasNotCalled();\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertActionWasQueued([\"ec:setAction\", \"add\"]);\nassertActionWasQueued([\"\
    ec:addProduct\", product]);\nassertActionWasQueued([\"ec:addImpression\", impression]);\n\
    assertEventWasSentWith(\"event\");"
- name: Should allow sending a Custom Coveo impression event
  code: "const product = {\n   \"productName\": \"wow\" \n};\n\ngivenScriptInitialized();\n\
    \ngivenMockDataLayer({\n  \"event\": \"impression\",\n  \"ecommerce\": {\n  \t\
    \"impression\": {\n      \"impressions\": [product],\n      \"actionField\": {\
    \ \"list\": \"coveo:search:1234\" },\n    }\n  }\n});\n\nconst mockData = {\n\
    \  \"eventType\": \"event\"\n};\n\nrunCode(mockData);\n\nassertApi('gtmOnFailure').wasNotCalled();\n\
    assertApi('gtmOnSuccess').wasCalled();\nassertActionWasQueued([\"ec:setAction\"\
    , \"impression\", { \"list\": \"coveo:search:1234\" }]);\nassertActionWasQueued([\"\
    ec:addImpression\", product]);\nassertEventWasSentWith(\"event\");"

- name: Sends a Page View event with custom data
  code: |-
    givenScriptInitialized();
    givenMockDataLayer({
      "event": "gtm.dom",
      "ecommerce": {}
    });

    runCode({
      "eventType": "view",
      "customDataObjects": [{
        "object": {
          "customA": "valueA",
        }
      }],
      "customDataTable": [{"key": "customB", "value": "valueB"}]
    });

    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertSendWasQueued("pageview", {
      "customA": "valueA",
      "customB": "valueB"
    });
- name: Sends a Page View event with custom data as objects
  code: |-
    givenScriptInitialized();
    givenMockDataLayer({
      "event": "gtm.dom",
      "ecommerce": {}
    });

    runCode({
      "eventType": "view",
      "customDataObjects": [{"object":"{\"customA\": {\"key\": \"value\"}}"}],
      "customDataTable": [{"key": "customB", "value": "{\"key\": \"value\"}"}]
    });

    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertSendWasQueued("pageview", {
      "customA": {
         "key": "value"
      },
      "customB": {
         "key": "value"
      }
    });
setup: "const assertActionWasQueued = (event) => {\n   const createArgumentsQueue\
  \ = require('createArgumentsQueue');\n   const coveoua = createArgumentsQueue('coveoua',\
  \ 'coveoua.q');\n\n   assertThat(coveoua.q).contains(event);\n};\n\nconst assertSendWasQueued\
  \ = (type, data) => {\n   const createArgumentsQueue = require('createArgumentsQueue');\n\
  \   const coveoua = createArgumentsQueue('coveoua', 'coveoua.q');\n  \n   assertThat(coveoua.q.length).isGreaterThan(0);\n\
  \   const eventsData = coveoua.q.filter(e => e[0] === \"send\" && e[1] === type).map(e\
  \ => e[2]);\n  \n  const logToConsole = require('logToConsole');\n   logToConsole(eventsData);\n\
  \  \n   if (data) {\n      assertThat(eventsData).contains(data);\n   } else {\n\
  \      assertThat(eventsData.length).isGreaterThan(0); \n   }\n};\n\nconst givenScriptInitialized\
  \ = () => {\n  const mockData = {\n    \"eventType\": \"load\",\n    \"apiKey\"\
  : \"1234-this-is-an-api-key\",\n    \"analyticsEndpoint\": \"https://somefakeendpoint\"\
  ,\n  };\n  \n  let initialized = false;\n  mock('injectScript', function(url, onSuccess,\
  \ onFailure) {\n    onSuccess();\n    initialized = true;\n  });\n  mock('copyFromWindow',\
  \ function(name) {\n    if (name === \"coveoua\") {\n      return initialized ?\
  \ {} : null; \n    }\n  });\n\n  runCode(mockData);\n  \n  assertApi('injectScript').wasCalled();\n\
  \  assertApi('gtmOnSuccess').wasCalled();\n  assertActionWasQueued([\"init\", mockData.apiKey,\
  \ mockData.analyticsEndpoint]);\n};\n\nconst givenMockDataLayer = (fakeDataLayer)\
  \ => { \n   mock('copyFromDataLayer', (name) => {\n     return fakeDataLayer[name];\n\
  \   });\n};\n \n\nconst assertEventWasSentWith = (event, data) => {\n   assertActionWasQueued(data\
  \ ? [\"send\", event, data] : [\"send\", event]);\n};"


___NOTES___

Created on 9/16/2019, 10:11:06 AM


